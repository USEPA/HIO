---
title: "WIO Model 4"
output: html_document
---

```{r setup, include=FALSE}
# devtools::install_github("USEPA/useeior@WIO")
# devtools::load_all(".") # this needs to point to the correct local useeior folder
# library('useeior')

configpaths <- file.path(c("USEEIO-WIO-Disagg.yml",
                          "DisaggWIOConcrete.yml",
                          "DisaggWIOFoodWaste.yml",
                          "LandfillingDisaggregation.yml",
                          "562OTHDisaggregation.yml",
                          "WasteCombustorsDisaggregation.yml",
                          "MRFsDisaggregation.yml"))


modelname <- "USEEIO-WIO-Disagg"
#model <- buildModel(modelname, configpaths)
model <- initializeModel(modelname, configpaths)
model <- loadIOData(model, configpaths)
model <- loadandbuildSatelliteTables(model)
model <- loadandbuildIndicators(model)
model <- loadDemandVectors(model)
model <- constructEEIOMatrices(model)

writeModeltoXLSX(model, file.path(rappdirs::user_data_dir(),
                                  "useeior/Model_Builds"))


## Generate results - Impacts of total US domestic production for each model by waste material
# Idea is to take the values stored in the factor_lists, which is in $/kg waste, and multiply that by the relevant 
# Waste Treatment Commodity values from the N and M tables to obtain results per kg waste.

# Concrete
# Extract total output by waste treatment commodities
concrete_sector_list <-  model$WasteTreatmentCommodities$Code_Loc[grepl('C',model$WasteTreatmentCommodities$Code)]
foodwaste_sector_list <- model$WasteTreatmentCommodities$Code_Loc[grepl('F',model$WasteTreatmentCommodities$Code)]
waste_treatment_commodity_list <- append(concrete_sector_list, foodwaste_sector_list)

totalImpacts_factor_list <- list()
directImpacts_factor_list <- list()
  
# Create final demand for total monetary amount of Waste Treatment Commodities.
for(sector in 1:length(concrete_sector_list)){
  # Get commodity index for current waste treatment commodity 
  comIndex <- which(model$Commodities$Code_Loc %in% concrete_sector_list[sector])
  # Get waste index for current waste (concrete)
  wasteIndex <- which(model$Commodities$Code_Loc %in% model$WasteGenMass$Code_Loc)[1]
  # Get total commodity output of current waste treatment commodity
  y <- model$q[comIndex] # in dollars
  y <- formatDemandVector(y, model$L)
  # Calculate total impacts based on waste treatment commodity total output
  X <- model$L %*% y
  # Divide the total impacts vector X by the total waste produced  
  X_normalized <- X/X[wasteIndex]
  
  # Save the normalized waste treatment commodity output, in terms of $/kg waste, to the factor_list
  totalImpacts_factor_list <- append(totalImpacts_factor_list, X_normalized[comIndex])
  
  
  # Calculate direct impacts 
  directImpacts <- (diag(1,dim(model$A)[1],dim(model$A)[2]) + model$A) %*% y
  
  directImpactsNormalized <- directImpacts/directImpacts[wasteIndex]
  
  directImpacts_factor_list <- append(directImpacts_factor_list, directImpactsNormalized[comIndex])
  
}

# Foodwaste
for(sector in 1:length(foodwaste_sector_list)){
  # Get commodity index for current waste treatment commodity 
  comIndex <- which(model$Commodities$Code_Loc %in% foodwaste_sector_list[sector])
  # Get waste index for current waste (concrete)
  wasteIndex <- which(model$Commodities$Code_Loc %in% model$WasteGenMass$Code_Loc)[2]
  # Get total commodity output of current waste treatment commodity
  y <- model$q[comIndex] # in dollars
  y <- formatDemandVector(y, model$L)
  # Calculate throughput based on waste treatment commodity total output
  X <- model$L %*% y
  # Divide the throughput vector X by the total waste produced  
  X_normalized <- X/X[wasteIndex]
  
  # Save the normalized waste treatment commodity output, in terms of $/kg waste, to the factor_list
  totalImpacts_factor_list <- append(totalImpacts_factor_list, X_normalized[comIndex])
  
    
  # Calculate direct impacts 
  directImpacts <- (diag(1,dim(model$A)[1],dim(model$A)[2]) + model$A) %*% y
  
  directImpactsNormalized <- directImpacts/directImpacts[wasteIndex]
  
  directImpacts_factor_list <- append(directImpacts_factor_list, directImpactsNormalized[comIndex])
  
}



# comIndex <- which(model$Commodities$Code_Loc %in% concrete_sector_list)
# y <- model$q[comIndex] # in dollars
# y <- formatDemandVector(y, model$L)
# 
# X <- model$L %*% y
# #Print total concrete waste
# CWasteIndex <- which(model$Commodities$Code %in% c("Concrete waste"))
# CWaste <- as.double(X[CWasteIndex,1])
# print(paste0("Total amount of concrete waste: ",CWaste, model$WasteGenMass$Unit[which(model$WasteGenMass$Code %in% "Concrete waste")]))

```


