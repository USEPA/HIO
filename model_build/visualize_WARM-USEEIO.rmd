---
title: "visualize_WARM-USEEIO"
output: html_notebook
---

## `renv` testing
```{r}
# install.packages("renv")  # install latest renv release into root env

## lockfile creation
# renv::activate()
# renv::install('remotes')
# remotes::install_github("USEPA/useeior@hybridization")
  # try useeior:::printValidationResults(model) or useeior:::hybridizeAMatrix to check for correct install
# renv::snapshot(lockfile="WARMer.lock")

## Populate an empty env w/ packages from existing lockfile
# renv::activate()
# renv::restore(lockfile="WARMer.lock")   

## Status checks
# renv::status(lockfile = "WARMer.lock")
# pkgs <- as.data.frame(installed.packages())
# .libPaths()

## Upadate useeior to latest commit: overwrite RemoteSha & delete Hash in lockfile
# renv::purge("useeior")  # purge old copy from cache
# renv::remove("useeior")
# remotes::install_github("USEPA/useeior@hybridization")  # reinstall
# renv::snapshot(lockfile="WARMer.lock")  # update the lockfile

## Wipe current renv & purge pkg cache
# renv::deactivate()
# renv::purge(".")  # purge all packages from cache
```


## Build the hybrid model
```{r}
library('useeior')
# devtools::load_all("./renv/library/R-4.1/x86_64-w64-mingw32/useeior")

# Build model from specs
configpaths <- file.path("data", c("USEEIO-WARM.yml",
                                   "WARMv15.yml"))
modelname <- "USEEIO-WARM"
model <- buildModel(modelname, configpaths)
```


## Tidy and manipulate
```{r, include=FALSE}
source("DataVisFunctions.R")

impact = "Greenhouse Gases"

df_A <- useeior:::disaggregateTotalToDirectAndTier1(model, impact) %>%
  dplyr::filter(stringr::str_detect(sector_code, 'WARM'), # keep WARM purchasing sectors
                impact_per_purchase != 0) %>%             # and non-0 purchases
  labelSectorPathwaysAndMaterials()
```


## Preliminary bar plot
```{r, fig.height = 6, fig.width = 12}
## Inspect available WARMer sector materials
# df_A %>% 
#   dplyr::mutate(
#     sector_material = stringr::str_extract(
#       sector, "(?<= of ).*(?=;)|(?<= of ).*")) %>% 
#   dplyr::distinct(sector_material) 

material_selection = "Grains"
p <- plotByMaterial(df_A, material_selection)
p
```
